# Lab #1

## Информация

University: [ITMO University](https://itmo.ru/ru/)
Faculty: [FICT](https://fict.itmo.ru)
Course: [Network programming](https://github.com/itmo-ict-faculty/network-programming)
Year: 2023/2024
Group: K34212
Author: Telnov Fedor Nikolaevich
Lab: Lab1
Date of create: 12.10.2024
Date of finished: 12.10.2024

## Прогресс

### Создание VM на платформе Google Cloud

Создается спотовый VM instance, регион сменяется на `europe-west3` - поскольку он находится во Франкфурте,
что обещает более оптимальную скорость подключения:

![vm reg](../assets/2024-10-29-16-49-03.png)

Выбирается вариация "micro" для экономии средств - излишняя мощность для сетевого подключения все равно без надобности:

![vm type](../assets/2024-10-29-16-49-52.png)

Чтобы дополнительно сэкономить средства, меняется тип диска на "standard persistent disk":

![vm disk selection](../assets/2024-10-29-16-47-44.png)

Итоговая информация о заказе:

![vm result order](../assets/2024-10-29-16-51-12.png)

### Установка Ansible на VM

Устанавливается pip:

![pip](../assets/2024-10-29-17-00-03.png)

Устанавливается pipx - он облегчает установку программ, написанных на Python - глобальная установка более не рекомендуется:

![pipx](../assets/2024-10-29-17-03-38.png)

![pipx_ensurepath](../assets/2024-10-29-17-04-31.png)

Наконец, устанавливается ansible и делается проверка его версии:

![ansible](../assets/2024-10-29-17-10-50.png)

### Установка Router OS(CHR) в VirtualBox

Router OS(CHR) скачивается с официального сайта в формате VMDK.
Через пункт New добавляется новая виртуальная машина, причем в качестве диска выбирается скачанный образ:

![add_vm](../assets/2024-10-29-18-15-46.png)

Далее запускается виртуальная машина и меняется пароль стандартного пользователя admin:

![change_pass](../assets/2024-10-29-18-19-50.png)

### Настройка OpenVPN-туннеля

На клиенте создается новый интерфейс ovpn-типа с передачей юзернейма и пароля - небезопасная практика, использована только для демонстрации:

![int_setup](../assets/2024-10-30-00-28-29.png)

Далее инициализируется статический маршрут для нужного ip-адреса пира на необходимый интерфейс и задается NAT-трансляция:

![setup_routes](../assets/2024-10-30-00-29-21.png)

С клиентом готово, теперь необходимо собрать демонстрационный вариант на сервере. Необходимо все же сгенерировать весь необходимый инвентарь для TLS, несмотря на то, что клиент не будет его верифицировать.

Устанавливается openvpn-пакет на удаленном сервере:

![openvpn_package](../assets/openvpn_package.png)

Генерируется весь обвяз для TLS:

```
cd /etc/openvpn
make-cadir easy-rsa/
cd easy-rsa/
./easyrsa init-pki
./easyrsa build-ca
./easyrsa build-server-full server
./easyrsa gen-dh
```

Далее создается простой bash-скрипт для аутенфикации клиента в рамках openvpn-сервера. Он просто ищет подходящую строку в файле с логинами и паролями:

![simple_auth](../assets/2024-10-30-00-35-05.png)

Наконец был написан конфиг для сервера, в котором используется TLS-обвяз и нужный скрипт для аутенфикации пользователя:

![server_conf](../assets/2024-10-30-00-37-33.png)

### Проверка работы туннеля

Сервер запускается с командой `sudo openvpn server.conf` - в логах видно, как подключается клиент:

![server_startup](../assets/2024-10-30-00-38-24.png)

Далее клиент пингует сервер:

![client_pings_server](../assets/2024-10-30-00-41-13.png)

Сервер пингует клиента:

![server_pings_client](../assets/2024-10-30-00-42-18.png)

## Выводы

OpenVPN клиент/сервер у RouterOS - какая-то шутка, необходимо постоянно искать паритет между поддерживаемыми фичами
клиента и сервера.
В данном случае из того, что RouterOS был раскатан на VirtualBox, туда было проблематично доставить сертификаты, в результате чего клиенту понадобилась очень тонкая настройка, чтобы избежать любого аспекта TLS.

У OpenVPN можно хорошо подоткнуть собственный метод аутенфикации - даже если это простенький скрипт.
